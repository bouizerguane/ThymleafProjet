<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Statistiques des Cours</h1>
            <p class="text-muted mb-0">Performance et remplissage des cours</p>
        </div>
    </div>

    <!-- Cartes de résumé -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body">
                    <h4 class="mb-0" id="totalEtudiants">0</h4>
                    <p class="mb-0">Étudiants total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body">
                    <h4 class="mb-0" id="totalCours">0</h4>
                    <p class="mb-0">Cours total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-white">
                <div class="card-body">
                    <h4 class="mb-0" id="moyenneRemplissage">0%</h4>
                    <p class="mb-0">Remplissage moyen</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info text-white">
                <div class="card-body">
                    <h4 class="mb-0" id="moyenneSucces">0%</h4>
                    <p class="mb-0">Succès moyen</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Étudiants inscrits par cours</h5>
                </div>
                <div class="card-body">
                    <canvas id="inscritsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Taux de succès par cours</h5>
                </div>
                <div class="card-body">
                    <canvas id="succesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadStats() {
            try {
                const response = await fetch('/stats/data');
                const data = await response.json();

                // Cartes
                const stats = data.statsGenerales || {};
                document.getElementById('totalEtudiants').textContent = stats.totalEtudiants || 0;
                document.getElementById('totalCours').textContent = stats.totalCours || 0;
                document.getElementById('moyenneRemplissage').textContent = (data.moyenneRemplissage || 0) + '%';
                document.getElementById('moyenneSucces').textContent = (data.moyenneSucces || 0) + '%';

                // Données graphiques
                const coursList = data.coursList;
                const labels = coursList.map(c => c.intitule);
                const inscritsData = coursList.map(c => data.inscritsParCours[c.id] || 0);
                const succesData = coursList.map(c => data.tauxSucces[c.id] || 0);

                // Graphique barres
                new Chart(document.getElementById('inscritsChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nombre d\'inscrits',
                            data: inscritsData,
                            backgroundColor: 'blue'
                        }]
                    }
                });

                // Graphique secteur
                new Chart(document.getElementById('succesChart'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: succesData,
                            backgroundColor: ['green', 'blue', 'orange', 'red']
                        }]
                    }
                });

            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</div>
</body>
</html>